<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 85vh;
            width: 100%;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .back-btn {
            padding: 8px 16px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 15px;
        }

        .location-info {
            display: inline-block;
            font-size: 14px;
            color: #666;
        }

        .status {
            margin-top: 5px;
            font-size: 12px;
        }

        .connected {
            color: green;
        }

        .disconnected {
            color: red;
        }
    </style>
</head>

<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'">Back to Dashboard</button>
        <div class="location-info">
            <strong>Current Bus Location:</strong>
            <span id="coordinates">Loading...</span>
            <div class="status">
                WebSocket: <span id="wsStatus" class="disconnected">Connecting...</span> |
                Last Update: <span id="lastUpdate">-</span>
            </div>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let busMarker;
        let ws;
        let currentLat = null;
        let currentLng = null;

        // Initialize map with coordinates from device or default location
        function initializeMap() {
            // Try to get coordinates from localStorage (passed from main dashboard)
            const storedLat = localStorage.getItem('busLatitude');
            const storedLng = localStorage.getItem('busLongitude');
            const lastUpdate = localStorage.getItem('lastUpdate');

            if (storedLat && storedLng && storedLat !== 'null' && storedLng !== 'null') {
                currentLat = parseFloat(storedLat);
                currentLng = parseFloat(storedLng);
                document.getElementById('lastUpdate').textContent = lastUpdate || 'Unknown';
                console.log('Using stored coordinates:', currentLat, currentLng);
            } else {
                // Default location (Kandy, Sri Lanka) - only if no GPS data available
                currentLat = 7.259723;
                currentLng = 80.599636;
                console.log('Using default coordinates (no GPS data available)');
            }

            // Create map
            map = L.map('map').setView([currentLat, currentLng], 15);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Create custom bus icon
            const busIcon = L.divIcon({
                html: 'ðŸšŒ',
                iconSize: [30, 30],
                className: 'bus-marker',
                iconAnchor: [15, 15]
            });

            // Add bus marker
            busMarker = L.marker([currentLat, currentLng], { icon: busIcon }).addTo(map);

            const isRealGPS = storedLat && storedLng && storedLat !== 'null' && storedLng !== 'null';
            busMarker.bindPopup(`
                <b>ðŸšŒ Bus Location</b><br>
                <strong>Latitude:</strong> ${currentLat.toFixed(6)}<br>
                <strong>Longitude:</strong> ${currentLng.toFixed(6)}<br>
                <strong>Data Source:</strong> ${isRealGPS ? 'ESP32 GPS' : 'Default Location'}<br>
                <strong>Last Update:</strong> ${lastUpdate || 'Unknown'}
            `).openPopup();

            updateCoordinatesDisplay();
        }

        // Update coordinates display in header
        function updateCoordinatesDisplay() {
            document.getElementById('coordinates').textContent =
                `${currentLat?.toFixed(6) || 'N/A'}, ${currentLng?.toFixed(6) || 'N/A'}`;
        }

        // Update WebSocket status indicator
        function updateWSStatus(status) {
            const statusElement = document.getElementById('wsStatus');
            statusElement.textContent = status;
            statusElement.className = status === 'Connected' ? 'connected' : 'disconnected';
        }

        // Performance optimization variables for map updates
        let mapUpdatePending = false;
        let latestMapData = null;
        const MAP_UPDATE_THROTTLE_MS = 500; // Update map max every 500ms

        // Throttled map update using requestAnimationFrame
        function throttledMapUpdate() {
            if (mapUpdatePending || !latestMapData) return;

            mapUpdatePending = true;
            requestAnimationFrame(() => {
                try {
                    performMapUpdate(latestMapData.lat, latestMapData.lng);
                } catch (error) {
                    console.error('Error during map update:', error);
                } finally {
                    mapUpdatePending = false;
                    latestMapData = null;
                }
            });
        }

        // Schedule map update with throttling
        function scheduleMapUpdate(lat, lng) {
            latestMapData = { lat, lng };

            if (!mapUpdatePending) {
                setTimeout(() => {
                    throttledMapUpdate();
                }, MAP_UPDATE_THROTTLE_MS);
            }
        }

        // Actual map update function
        function performMapUpdate(lat, lng) {
            const newLat = parseFloat(lat);
            const newLng = parseFloat(lng);

            // Only update if coordinates actually changed significantly
            const threshold = 0.000001;
            if (Math.abs(newLat - currentLat) > threshold || Math.abs(newLng - currentLng) > threshold) {
                currentLat = newLat;
                currentLng = newLng;

                console.log('Updating bus location to:', currentLat, currentLng);

                // Update marker position
                busMarker.setLatLng([currentLat, currentLng]);

                // Update popup content with real-time data
                busMarker.setPopupContent(`
                    <b>ðŸšŒ Bus Location (Live)</b><br>
                    <strong>Latitude:</strong> ${currentLat.toFixed(6)}<br>
                    <strong>Longitude:</strong> ${currentLng.toFixed(6)}<br>
                    <strong>Data Source:</strong> ESP32 GPS (Real-time)<br>
                    <strong>Last Update:</strong> ${new Date().toLocaleString()}
                `);

                // Smoothly pan map to new location
                map.panTo([currentLat, currentLng]);

                // Update display
                updateCoordinatesDisplay();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

                // Store updated coordinates in localStorage
                localStorage.setItem('busLatitude', currentLat);
                localStorage.setItem('busLongitude', currentLng);
                localStorage.setItem('lastUpdate', new Date().toLocaleString());
            }
        }

        // Update bus location on map with new coordinates from ESP32
        function updateBusLocation(lat, lng) {
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                scheduleMapUpdate(lat, lng);
            }
        }

        // Connect to WebSocket for real-time GPS updates from ESP32 with exponential backoff
        let wsReconnectAttempts = 0;
        const WS_MAX_RECONNECT_DELAY = 30000;
        const WS_BASE_RECONNECT_DELAY = 1000;

        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8000/ws");

            ws.onopen = () => {
                console.log("WebSocket connected - ready to receive GPS updates");
                updateWSStatus("Connected");
                wsReconnectAttempts = 0; // Reset on successful connection
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected. Attempting to reconnect...");
                updateWSStatus("Disconnected");

                // Exponential backoff with jitter
                const delay = Math.min(
                    WS_BASE_RECONNECT_DELAY * Math.pow(2, wsReconnectAttempts),
                    WS_MAX_RECONNECT_DELAY
                );
                const jitter = Math.random() * 1000;

                wsReconnectAttempts++;
                console.log(`Map WS reconnect attempt ${wsReconnectAttempts} in ${(delay + jitter) / 1000}s`);

                setTimeout(connectWebSocket, delay + jitter);
            };

            ws.onerror = (err) => {
                console.error("WebSocket error:", err);
                updateWSStatus("Error");
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Check if we have valid GPS coordinates from ESP32
                    if (data.latitude && data.longitude) {
                        updateBusLocation(data.latitude, data.longitude);
                    }
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                }
            };
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Bus location page loaded');
            initializeMap();
            connectWebSocket();
        });
    </script>
</body>

</html>